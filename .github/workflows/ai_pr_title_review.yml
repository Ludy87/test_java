name: AI - PR Title Review

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches: [main]

jobs:
  ai-title-review:
    permissions:
      contents: read
      pull-requests: write
      models: read

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: blob:none

      - name: Setup GitHub App Bot
        id: setup-bot
        uses: ./.github/actions/setup-bot
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Get PR diff
        id: get_diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI PR Title Analysis
        id: ai-title-analysis
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o
          prompt: |
            You are a professional software engineer. Based on the following git diff, generate a **concise** and **meaningful** pull request title in **English**, using **Markdown format** and starting with one of the conventional commit types:
            build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test.

            Do NOT use emojis. Do NOT include additional description.

            Example: `refactor: improve session lifecycle handling in login filter`

            Git diff:
            ```
            ${{ steps.get_diff.outputs.diff }}
            ```

            Compare the PR title `${{ github.event.pull_request.title }}` with your AI-generated title. Evaluate the PR title using the following criteria:

            - It must meaningfully describe the change and reflect the content of the diff.
            - Titles like "1", "update", "fix", or any title under 5 characters must be rated no higher than 3/10.
            - If the title fails these rules, provide a corrected title.

            Respond ONLY in strict valid JSON (no markdown, no code fences, no trailing commas) with the following fields:
            {
              "improved_rating": "<your rating of the current PR title out of 10>",
              "improved_ai_title_rating": "<your rating of your suggested title>",
              "improved_title": "<your improved title>"
            }

      - name: Set SCRIPT_OUTPUT env var safely
        run: |
          echo '${{ steps.ai-title-analysis.outputs.response }}' > ai_response.json

          # Parse JSON fields using jq
          IMPROVED_RATING=$(jq -r '.improved_rating // "?"' ai_response.json)
          IMPROVED_TITLE=$(jq -r '.improved_title // "?"' ai_response.json)

          cat > /tmp/ai-title-comment.md <<EOF
          ## 🤖 AI PR Title Suggestion

          **PR-Title Rating**: $IMPROVED_RATING

          ### ⬇️ Suggested Title (copy & paste):
          \`\`\`
          $IMPROVED_TITLE
          \`\`\`

          ---
          *Generated by GitHub Models AI*
          EOF

      - name: Post comment on PR if needed
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.setup-bot.outputs.token }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/ai-title-comment.md', 'utf8');
            const { GITHUB_REPOSITORY } = process.env;
            const [owner, repo] = GITHUB_REPOSITORY.split('/');
            const issue_number = context.issue.number;

            const ratingMatch = body.match(/\*\*PR-Title Rating\*\*: (\d+)\/10/);
            const rating = ratingMatch ? parseInt(ratingMatch[1], 10) : null;

            const expectedActor = "${{ steps.setup-bot.outputs.app-slug }}[bot]";
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number });

            const existing = comments.data.find(c =>
              c.user?.login === expectedActor &&
              c.body.includes("## 🤖 AI PR Title Suggestion")
            );

            if (rating === null) {
              console.log("No rating found in AI response – skipping.");
              return;
            }

            if (rating <= 5) {
              if (existing) {
                await github.rest.issues.updateComment({
                  owner, repo,
                  comment_id: existing.id,
                  body
                });
                console.log("Updated existing suggestion comment.");
              } else {
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body
                });
                console.log("Created new suggestion comment.");
              }
            } else {
              const praise = `## 🤖 AI PR Title Suggestion\n\nGreat job! The current PR title is clear and well-structured.\n\n✅ No suggestions needed.\n\n---\n*Validated by GitHub Models AI*`;

              if (existing) {
                await github.rest.issues.updateComment({
                  owner, repo,
                  comment_id: existing.id,
                  body: praise
                });
                console.log("Replaced suggestion with praise.");
              } else {
                console.log("Rating > 5 and no existing comment → skipping comment.");
              }
            }
