name: PR Deployment via Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    if: |
      github.event.issue.pull_request &&
      (
        contains(github.event.comment.body, 'prdeploy') ||
        contains(github.event.comment.body, 'deploypr')
      )
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate commenter is in allowed list
        id: validate-commenter
        env:
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          FILE=".github/config/repo_devs.json"

          if [ ! -f "$FILE" ]; then
            echo "❌ Error: $FILE not found" >&2
            exit 1
          fi

          # Extract list and check
          if jq -e --arg user "$COMMENT_USER" '.repo_devs_comment | index($user)' "$FILE" > /dev/null; then
            echo "✅ $COMMENT_USER is authorized to trigger deployment"
            echo allowed_user=true >> $GITHUB_OUTPUT
          else
            echo "❌ $COMMENT_USER is not authorized to deploy" >&2
            echo allowed_user=false >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Trigger Deployment
        if: steps.validate-commenter.outputs.allowed_user == 'true'
        run: |
          echo "🚀 Deployment triggered by ${{ github.event.comment.user.login }}!"
          # Here you would add the actual deployment logic, e.g., calling a script or API
          # ./deploy_script.sh
          echo "Deployment logic goes here."
